---
title: "Macrophage GxE study QC report"
output:
  html_document:
    keep_md: yes
---
  
```{r echo=FALSE}
# This chunk contains some setup which we do not want to display in the final
# document, hence `echo=FALSE` is used.
# When you’re reading this document, it may be easier to ignore this chunk for
# now, and continue with the document below, starting at “Introduction”
 
# Make library loading silent
library = function (...) suppressMessages(base::library(...))
library("knitr")
opts_knit$set(root.dir = '../../../')
library("ggplot2")
library("gplots")
library("devtools")
library("dplyr")
load_all("../../../../seqUtils/")
load_all("../seqUtils/")
```

Load eQTL dataset from disk and extract peer factors for different conditions
```{r}
data_list = readRDS("results/SL1344/eqtl_data_list.rds")
naive_peer = data_list$covariates_list[[1]][4:13,]
IFNg_peer = data_list$covariates_list[[2]][4:13,]
SL1344_peer = data_list$covariates_list[[3]][4:13,]
IFNg_SL1344_peer = data_list$covariates_list[[4]][4:13,]

```

Convert the PEER matrices into data frames
```{r}
naive_peer_df = dplyr::mutate(as.data.frame(t(naive_peer)), donor = colnames(naive_peer))
naive_df = dplyr::filter(data_list$sample_metadata, condition == "A") %>% dplyr::left_join(naive_peer_df,by = "donor")

```

Focus on the relationship between purity and first PEER factor
```{r}
purity_df = dplyr::filter(naive_df, mean_purity_filtered > 0.90)
peer1_plot = ggplot(purity_df, aes(x = mean_purity_filtered, y = PEER_factor_1)) + 
  geom_point() +
  xlab("Mean purity") + 
  ylab("PEER factor 1")
ggsave("results/SL1344/varComp/purity_vs_PEER_factor_1.pdf", peer1_plot, width = 5, height = 5)
cor(purity_df$mean_purity_filtered, purity_df$PEER_factor_1, use = "complete.obs")


peer1_plot_2 = ggplot(purity_df, aes(x = ng_ul_mean, y = PEER_factor_1)) + 
  geom_point() +
  xlab("Cell density (rna concentration)") + 
  ylab("PEER factor 1")
ggsave("results/SL1344/varComp/rna_concetration_vs_PEER_factor_1.pdf", peer1_plot_2, width = 5, height = 5)

```

Focus on the relationship between sequencing chemistry and first PEER factor
```{r}
chemistry_df = dplyr::mutate(naive_df, rna_auto = ifelse(chemistry == "V4_auto", "automatic", "manual"))
peer2_plot = ggplot(chemistry_df, aes(x = rna_auto, y = PEER_factor_2)) + 
  geom_boxplot(outlier.shape = NA) +
   geom_jitter(position = position_jitter(width = .1)) + 
  xlab("RNA sequening chemistry") + 
  ylab("PEER factor 2")
ggsave("results/SL1344/varComp/purity_vs_PEER_factor_2.pdf", peer2_plot, width = 5, height = 5)
cor(as.numeric(factor(chemistry_df$rna_auto)) , chemistry_df$PEER_factor_2, use = "complete.obs")
```

Look at the variation explained by each PEER factor,
```{r}
prec_naive = read.table("results/SL1344/PEER/naive_10/precision.txt", sep = ",")
prec_ifng = read.table("results/SL1344/PEER/IFNg_10/precision.txt", sep = ",")
prec_sl1344 = read.table("results/SL1344/PEER/SL1344_10//precision.txt", sep = ",")
prec_ifng_sl1344 = read.table("results/SL1344/PEER/IFNg_SL1344_10//precision.txt", sep = ",")

#Combine it all together
precision_df = 1/cbind(prec_naive, prec_ifng, prec_sl1344, prec_ifng_sl1344)[-1,]
colnames(precision_df) = c("Naive", "IFNg", "SL1344", "IFNg_SL1344")
precision_df = dplyr::mutate(precision_df, factor = paste("PEER_factor_", c(1:10), sep = "")) %>% 
  dplyr::mutate(factor = factor(factor, factor)) %>%
  tidyr::gather(condition, sd, Naive:IFNg_SL1344)

#Make a plot
precision_plot = ggplot(precision_df, aes(x = factor, y = sd, color = condition, group = condition)) +
  geom_point() + 
  geom_line() +
  ylab("1 / precision") + 
  theme(axis.text.x = element_text(angle = 25))
precision_plot
ggsave("results/SL1344/varComp/PEER_explained.pdf", precision_plot, width = 7, height = 5)
```

Explore the correlation between PEER factors
```{r, fig.width = 8, fig.height = 8}
heatmap.2(abs(cor(t(naive_peer))), margins = c(10,10))
heatmap.2(abs(cor(t(SL1344_peer))), margins = c(10,10))
heatmap.2(abs(cor(t(IFNg_SL1344_peer))), margins = c(10,10))
heatmap.2(abs(cor(t(IFNg_peer))), margins = c(10,10))

```

Identify which factors are most correlated with PEER factors
```{r,fig.width = 8, fig.height = 6}
covariates = dplyr::select(expanded_meta, mean_purity_filtered, ng_ul_mean, RNAseq_auto, diff_days, passage_diff)

peer_explained = explainPEER(peer_factors[,1:5], covariates)
peer_explained$peer_factor = factor(peer_explained$peer_factor, 
                                    levels = paste("PEER_factor_", c(1:ncol(peer_factors)), sep = ""))
ggplot(peer_explained, aes(x = peer_factor, y = covariate, fill = sqrt(r_squared))) + 
  geom_tile() + 
  scale_fill_gradient2(space = "Lab", low = scales::muted("blue"), 
                       high = scales::muted("red"), midpoint = 0.4, name = "Correlation")
```

Make the same plot by excluding some of the purity outliers
```{r, fig.width = 8, fig.height = 6}
filter = expanded_meta$mean_purity_filtered > 0.95
peer_explained = explainPEER(peer_factors[filter,1:5], covariates[filter,])
peer_explained$peer_factor = factor(peer_explained$peer_factor, 
                                    levels = paste("PEER_factor_", c(1:ncol(peer_factors)), sep = ""))
ggplot(peer_explained, aes(x = peer_factor, y = covariate, fill = sqrt(r_squared))) + 
  geom_tile() + 
  scale_fill_gradient2(space = "Lab", low = scales::muted("blue"), 
                       high = scales::muted("red"), midpoint = 0.4, name = "Correlation")
```

Visualize the RNA-Seq batch effect,
```{r,fig.width = 8, fig.height = 6}
ggplot(expanded_meta, aes(x = PEER_factor_1, y = PEER_factor_2, label = sample_id, color = RNAseq_auto)) + 
  geom_point() + geom_text()
```

Visualize the purity effect with one outlier,
```{r,fig.width = 8, fig.height = 6}
ggplot(expanded_meta, aes(x = mean_purity_filtered, y = PEER_factor_1, label = sample_id)) + 
  geom_point() + geom_text()
```

Remove bubh outlier,
```{r,fig.width = 8, fig.height = 6}
ggplot(dplyr::filter(expanded_meta, mean_purity_filtered > 0.9), aes(x = mean_purity_filtered, y = PEER_factor_1, label = sample_id)) + 
  geom_point() + geom_text()
```

Correlation between factor 1 and RNA concentration
```{r,fig.width = 8, fig.height = 6}
ggplot(expanded_meta, aes(x = ng_ul_mean, y = PEER_factor_1, label = sample_id)) + geom_point() + geom_text()
cor.test(as.numeric(factor(expanded_meta$ng_ul_mean)), expanded_meta$PEER_factor_1, method = "pearson")
```

#Factors detected in Salmonella condition
```{r}
precisions = read.table("results/SL1344/PEER/25_factors_cond_C/precision.txt", sep = ",")
precisions_vec = precisions$V1[2:nrow(precisions)]
plot(1/precisions_vec)
```

Import PEER results
```{r}
peer_factors = read.table("results/SL1344/PEER/25_factors_cond_C/factors.txt", sep =",")
peer_factors = peer_factors[,2:ncol(peer_factors)]
colnames(peer_factors) = paste("PEER_factor_", c(1:ncol(peer_factors)), sep = "")
```

Add PEER results to the sample metadata
```{r}
peer_factors_2 = dplyr::mutate(peer_factors, sample_id = line_meta$sample_id)
expanded_meta = dplyr::left_join(line_meta, peer_factors_2, by = "sample_id")
expanded_meta = dplyr::mutate(expanded_meta, RNAseq_auto = ifelse(chemistry == "V4_auto", "yes", "no"))
```

ggplot(expanded_meta, aes(x = PEER_factor_1, y = PEER_factor_2, label = sample_id, color = RNAseq_auto)) + 
  geom_point() + geom_text()
  
Remove bubh outlier,
```{r,fig.width = 8, fig.height = 6}
ggplot(dplyr::filter(expanded_meta, mean_purity_filtered > 0.9), aes(x = mean_purity_filtered, y = PEER_factor_1, label = sample_id)) + 
  geom_point() + geom_text()
```

```{r,fig.width = 8, fig.height = 6}
ggplot(expanded_meta, aes(x = RNAseq_auto, y = PEER_factor_3, label = sample_id, color = RNAseq_auto)) + 
  geom_point() + geom_text()
```

